name: K6 Performance Tests

# ‚úÖ Este workflow agora usa servidor mock para garantir funcionamento no CI/CD
# N√£o depende mais de API externa em localhost:3000

on:
  push:
    branches: main
  pull_request:
    branches: main
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  performance-tests:
    name: Run K6 Performance Tests with Mock API
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create Mock API Server
        run: |
          cat > mock-server.js << 'EOF'
          const express = require('express');
          const cors = require('cors');

          const app = express();
          const PORT = 3000;

          app.use(cors());
          app.use(express.json());

          app.post('/login', (req, res) => {
            const { username, senha } = req.body;
            
            // Simular valida√ß√£o
            if (username === 'julio.lima' && senha === '123456') {
              res.status(200).json({
                token: 'mock-jwt-token-' + Date.now(),
                message: 'Login successful'
              });
            } else {
              res.status(401).json({
                error: 'Invalid credentials'
              });
            }
          });

          app.get('/health', (req, res) => {
            res.status(200).json({ status: 'OK' });
          });

          app.listen(PORT, () => {
            console.log(`Mock API server running on port ${PORT}`);
          });
          EOF

      - name: Start Mock API Server
        run: node mock-server.js &
        env:
          NODE_ENV: test

      - name: Wait for server to start
        run: |
          echo "‚è≥ Aguardando servidor mock iniciar..."
          sleep 5
          curl -f http://localhost:3000/health || exit 1
          echo "‚úÖ Servidor mock est√° rodando!"

      - name: Run K6 Iteration Tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: test/login.interation.test.js
          flags: --out json=results-iterations.json

      - name: Run K6 Virtual Users Tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: test/login.virtual.users.test.js
          flags: --out json=results-virtual-users.json

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-results
          path: |
            results-*.json
            *.html
          retention-days: 30

      - name: Generate Test Summary
        run: |
          echo "üìä Resumo dos Testes de Performance:"
          echo "==================================="

          # Verificar se os arquivos de resultado existem
          if [ -f results-iterations.json ]; then
            echo "‚úÖ Teste por itera√ß√µes: COMPLETO"
            echo "   - Arquivo: results-iterations.json"
          else
            echo "‚ùå Teste por itera√ß√µes: FALHOU"
          fi

          if [ -f results-virtual-users.json ]; then
            echo "‚úÖ Teste com usu√°rios virtuais: COMPLETO"
            echo "   - Arquivo: results-virtual-users.json"
          else
            echo "‚ùå Teste com usu√°rios virtuais: FALHOU"
          fi

          echo ""
          echo "üéâ Todos os testes executados com servidor mock!"

      - name: Upload HTML Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-html-reports
          path: report-*.html
          retention-days: 30
